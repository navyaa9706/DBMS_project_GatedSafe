create database Visitor_management_db;
use Visitor_management_db;

create table Visitors(
VID int primary key,
v_name varchar(30),
contact char(10),
no_of_visits int,
is_frequent boolean
);

create table Residents(
RID int primary key,
r_name varchar(30),
flat_no int,
is_primary boolean,
email varchar(30),
contact char(10), 
move_in_date date,
emergency_contact char(10)
);

create table Flats(
flat_no int primary key,
floor_no int,
block int,
intercom int,
is_occupied boolean
);

create table SecurityGuards(
GID int primary key,
g_name varchar(30),
contact char(10),
shift_start timestamp,
shift_end timestamp,
is_active Boolean,
assigned_block int
);

create table EntryExitLogs(
log_id int primary key auto_increment,
visitor_name varchar(30),
visitor_contact char(10),
flat_no int, 
purpose varchar(30),
entry_time datetime,
exit_time datetime,
entry_gate int,
exit_gate int,
status varchar(20),
verified_by_guard int
);

CREATE TABLE fixed_visitors (
    fix_visitor_id INT PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    visitor_type ENUM('Maid','Tutor','Driver','Cook','Gardener','Milkman','Newspaper Vendor','Other') NOT NULL,
    gender ENUM('Male','Female','Other'),
    phone_number VARCHAR(15) NOT NULL,
    alt_phone_number VARCHAR(15),
    address VARCHAR(255),
    assigned_house_id INT,
    allowed_days VARCHAR(50),
    allowed_time_start TIME,
    allowed_time_end TIME,
    date_registered DATE DEFAULT (CURDATE()),
    status ENUM('Active','Inactive','Blacklisted') DEFAULT 'Active',
    remarks VARCHAR(255),
    FOREIGN KEY (assigned_house_id) REFERENCES Flats(flat_no)
);

CREATE TABLE OverstayNotifications (
    notification_id INT AUTO_INCREMENT PRIMARY KEY,
    visitor_name VARCHAR(100),
    visitor_contact VARCHAR(15),
    flat_no INT,
    entry_time DATETIME,
    allowed_time_end TIME,
    notified_guard INT,
    notified_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    message VARCHAR(255)
);

alter table EntryExitLogs add foreign key(verified_by_guard) references SecurityGuards(GID);
alter table EntryExitLogs add foreign key(flat_no) references Flats(flat_no);
alter table Residents add foreign key(flat_no) references Flats(flat_no);

DELIMITER $$

CREATE PROCEDURE check_overstayed_visitors()
BEGIN
    INSERT INTO OverstayNotifications (visitor_name, visitor_contact, flat_no, entry_time, allowed_time_end, notified_guard, message)
    SELECT 
        e.visitor_name,
        e.visitor_contact,
        e.flat_no,
        e.entry_time,
        f.allowed_time_end,
        e.verified_by_guard,
        CONCAT('Fixed visitor ', e.visitor_name, ' has overstayed beyond allowed time.')
    FROM EntryExitLogs e
    JOIN Fixed_visitors f 
        ON e.visitor_contact = f.phone_number
    WHERE 
        e.exit_time IS NULL
        AND CURTIME() > f.allowed_time_end
        AND e.status = 'Inside'
        AND NOT EXISTS (
            SELECT 1 FROM OverstayNotifications n
            WHERE n.visitor_name = e.visitor_name
              AND DATE(n.notified_at) = CURDATE()
        );
    INSERT INTO OverstayNotifications (visitor_name, visitor_contact, flat_no, entry_time, allowed_time_end, notified_guard, message)
    SELECT 
        e.visitor_name,
        e.visitor_contact,
        e.flat_no,
        e.entry_time,
        NULL AS allowed_time_end,
        e.verified_by_guard,
        CONCAT('Visitor ', e.visitor_name, ' has stayed more than 1 hour.')
    FROM EntryExitLogs e
    WHERE 
        e.exit_time IS NULL
        AND e.status = 'Inside'
        AND NOT EXISTS (
            SELECT 1 FROM Fixed_visitors f
            WHERE f.phone_number = e.visitor_contact
        )
        AND TIMESTAMPDIFF(MINUTE, e.entry_time, NOW()) > 60
        AND NOT EXISTS (
            SELECT 1 FROM OverstayNotifications n
            WHERE n.visitor_name = e.visitor_name
              AND DATE(n.notified_at) = CURDATE()
        );
END$$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE emergency_lookup(
    IN incident_time DATETIME,
    IN flat_number INT
)
BEGIN
    SELECT 
        e.visitor_name,
        e.visitor_contact,
        e.flat_no,
        e.purpose,
        e.entry_time,
        e.exit_time,
        CASE 
            WHEN e.exit_time IS NULL THEN 'Still Inside'
            WHEN e.exit_time > incident_time THEN 'Inside During Incident'
            WHEN e.exit_time < incident_time THEN 'Already Left'
            ELSE 'Unknown'
        END AS visitor_status,
        g.g_name AS verified_guard,
        g.contact AS guard_contact
    FROM EntryExitLogs e
    LEFT JOIN SecurityGuards g ON e.verified_by_guard = g.GID
    WHERE 
        e.flat_no = flat_number
        AND (
            (e.entry_time <= incident_time AND (e.exit_time IS NULL OR e.exit_time >= incident_time))
            OR ABS(TIMESTAMPDIFF(MINUTE, e.entry_time, incident_time)) <= 30
        )
    ORDER BY e.entry_time DESC;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER check_flat_occupied
BEFORE INSERT ON EntryExitLogs
FOR EACH ROW
BEGIN
    DECLARE flat_status BOOLEAN;
    SELECT is_occupied INTO flat_status
    FROM Flats
    WHERE flat_no = NEW.flat_no;
    IF flat_status IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Flat number not found.';
    ELSEIF flat_status = FALSE THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Error: Flat is unoccupied. Entry not allowed.';
    END IF;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER add_new_visitor
AFTER INSERT ON EntryExitLogs
FOR EACH ROW
BEGIN
    IF NOT EXISTS (
        SELECT 1
        FROM Visitors
        WHERE contact = NEW.visitor_contact
          AND v_name = NEW.visitor_name
    ) THEN
        INSERT INTO Visitors (VID, v_name, contact, no_of_visits, is_frequent)
        VALUES (
            (SELECT IFNULL(MAX(VID), 0) + 1 FROM Visitors),
            NEW.visitor_name,
            NEW.visitor_contact,
            1,
            FALSE
        );
    ELSE
        UPDATE Visitors
        SET no_of_visits = no_of_visits + 1,
            is_frequent = (no_of_visits + 1) > 5
        WHERE contact = NEW.visitor_contact
          AND v_name = NEW.visitor_name;
    END IF;
END$$
DELIMITER ;

DELIMITER $$

CREATE TRIGGER update_visitor_visits
AFTER INSERT ON EntryExitLogs
FOR EACH ROW
BEGIN
    IF EXISTS (
        SELECT 1
        FROM Visitors
        WHERE contact = NEW.visitor_contact
          AND v_name = NEW.visitor_name
    ) THEN
        UPDATE Visitors
        SET no_of_visits = no_of_visits + 1,
            is_frequent = (no_of_visits + 1) >= 5 
        WHERE contact = NEW.visitor_contact
          AND v_name = NEW.visitor_name;
    ELSE
        INSERT INTO Visitors (VID, v_name, contact, no_of_visits, is_frequent)
        VALUES (
            (SELECT IFNULL(MAX(VID), 0) + 1 FROM Visitors), 
            NEW.visitor_name,
            NEW.visitor_contact,
            1,
            FALSE
        );
    END IF;
END$$
DELIMITER ;
